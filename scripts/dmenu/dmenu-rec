#!/usr/bin/env bash

# Tema
source ~/.theme_selected

# Diretório de gravação
OUTPUT_DIR="$HOME/Vídeos/rec"
mkdir -p "$OUTPUT_DIR"

# Arquivo para armazenar PID do processo de gravação
PID_FILE="/tmp/rec_pid"

# Função para listar telas disponíveis
list_screens() {
    xrandr --query | grep " connected" | while read -r line; do
        screen=$(echo "$line" | awk '{print $1}')
        resolution=$(echo "$line" | grep -oP '\d{3,}x\d{3,}\+\d+\+\d+')
        echo "$screen - $resolution"
    done
}

# Verificar se há gravação em andamento
if [[ -f $PID_FILE && -s $PID_FILE ]]; then
    rec_pid=$(cat "$PID_FILE")
    if kill -0 "$rec_pid" 2>/dev/null; then
        # Perguntar ao usuário se deseja encerrar a gravação
        choice=$(printf "Sim\nNão\n" | dmenu -p "Gravação em andamento. Deseja encerrar?")
        if [[ "$choice" == "Sim" ]]; then
            kill -SIGINT "$rec_pid" && rm -f "$PID_FILE"
            notify-send -h string:fgcolor:$COLOR_3 " Gravação encerrada." --icon="/usr/share/icons/ePapirus/24x24/panel/kazam-stopped.svg"
            kill -45 $(pidof dwmblocks)
        fi
        exit 0
    else
        # Remove PID inválido
        rm -f "$PID_FILE"
    fi
fi

# Listar telas disponíveis com xrandr
screens=$(list_screens)

# Montar lista para o dmenu
if [[ -z "$screens" ]]; then
    notify-send -h string:fgcolor:$COLOR_3 "󰶐 Nenhuma tela conectada." --icon="/usr/share/icons/ePapirus/24x24/panel/simplescreenrecorder-error.svg"
    exit 1
fi

# Selecionar tela com o dmenu
selected_screen=$(printf "%b" "$screens" | dmenu -p "Selecione a tela para gravar:")
if [[ -z "$selected_screen" ]]; then
    notify-send -h string:fgcolor:$COLOR_3 " Gravação cancelada." --icon="/usr/share/icons/ePapirus/24x24/panel/simplescreenrecorder-error.svg"
    exit 1
fi

# Extrair dimensões e posição da tela selecionada
resolution=$(echo "$selected_screen" | awk -F ' - ' '{print $2}' | awk -F '+' '{print $1}')
offset=$(echo "$selected_screen" | awk -F ' - ' '{print $2}' | awk -F '+' '{print $2"+"$3}')

if [[ -z "$resolution" || -z "$offset" ]]; then
    notify-send -h string:fgcolor:$COLOR_3 " Tela inválida selecionada." --icon="/usr/share/icons/ePapirus/24x24/panel/simplescreenrecorder-error.svg"
    exit 1
fi

# Arquivo de saída
video_file="$OUTPUT_DIR/video_$(date '+%Y-%m-%d_%H-%M-%S').mp4"

# Popup para indicar inicio da gravacao de tela
notify-send -h string:fgcolor:$COLOR_3 " Gravação tela iniciada em $selected_screen" --icon="/usr/share/icons/ePapirus/24x24/panel/simplescreenrecorder-recording.svg"

# Inicia a gravacao
#
# Grava apenas o audio do microfone
#ffmpeg -video_size "$resolution" -framerate 30 -f x11grab -i ":0.0+$offset" -f pulse -i default \
#    -c:v h264 -qp 0 -c:a aac "$video_file" &

# Grava audio do microfone e do computador
ffmpeg -video_size "$resolution" -framerate 30 -f x11grab -i ":0.0+$offset" \
    -f pulse -i $(pactl get-default-source) \
    -f pulse -i $(pactl list sources short | grep monitor | awk '{print $2}' | grep $(pactl get-default-sink)) \
    -filter_complex "[1:a][2:a]amix=inputs=2:duration=longest[aout]" \
    -map 0:v -map "[aout]" \
    -c:v h264 -qp 0 -c:a aac "$video_file" &


# Salvar PID e monitorar processo
echo $! > "$PID_FILE"

# Atualiza dwmblocks
kill -45 $(pidof dwmblocks)

exit 0
