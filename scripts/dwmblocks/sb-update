#!/bin/bash

# Carrega informacoes do modo de operacao
arquivo_modo="$HOME/.cache/dwmblocks_modo_operacao"

if [ -f $arquivo_modo ]; then
    source $arquivo_modo
else
    OPERATION_MODE="COMPLETO"
fi

# Carrega as cores do tema
source ~/.theme_selected

# L√™ o nome da distribui√ß√£o a partir do arquivo /etc/os-release
if [ -f /etc/os-release ]; then
    . /etc/os-release
    case "$ID" in
        arch)
            updates=$(checkupdates | wc -l)
        ;;

        debian)
            updates=$(apt list --upgradable 2>/dev/null | grep -c 'upgradable')
        ;;
        *)
            echo "Sistema desconhecido ou n√£o suportado: $ID"
        ;;
    esac
else
    echo "N√£o foi poss√≠vel determinar a distribui√ß√£o. O arquivo /etc/os-release n√£o existe."
fi

icon="üì¶"
# Apresentacao condicionada
case "$OPERATION_MODE" in
    "MINIMO")
        echo ""
    ;;
    *)
        case "$updates" in
            0)
                echo ""
                ;;
            [1-9]|10)
                echo "^b$COLOR_7^^c$COLOR_BACKGROUND^ $icon ^d^^c$COLOR_7^ $updates  "
                ;;
            [1-4][0-9]|50)
                echo "^b$COLOR_1^^c$COLOR_BACKGROUND^ $icon ^d^^c$COLOR_1^ $updates  "
                ;;
            [5-9][0-9]|100)
                echo "^b$COLOR_2^^c$COLOR_BACKGROUND^ $icon ^d^^c$COLOR_2^ $updates  "
                ;;
            *)
                echo "^b$COLOR_3^^c$COLOR_BACKGROUND^ $icon ^d^^c$COLOR_3^ $updates  "
                ;;
        esac

        if [ -n "$updates" ] && [ "$updates" -gt 0 ]; then
            notify-send -i "/usr/share/icons/Adwaita/24x24/legacy/software-update-available.png" \
                "Û±ßï Atualiza√ß√£o Dispon√≠vel" \
                "Existem <b>$updates</b> atualiza√ß√µes dispon√≠veis, que s√£o: \n$(checkupdates | sed 's/^/\t/')"
        fi
    ;;
esac

# funcoes cliclaveis
case $BUTTON in
    1) st -n "updates" -e sh -c "sudo pacman -Syuv ; kill -36 $(pidof dwmblocks)" & ;;
    3) x-www-browser "https://flathub.org/" ;;
    6) setsid -f st -e emacs -nw "$0" ;;
esac
